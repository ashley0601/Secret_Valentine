<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Secret Valentine PH</title>
  {% load static %}
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a0a14;
      --bg-secondary: #2d1520;
      --fg-primary: #fff5f8;
      --fg-secondary: #ffb8c6;
      --accent: #ff4d6d;
      --accent-soft: #ff758f;
      --border: rgba(255, 77, 109, 0.3);
      --card-bg: rgba(45, 21, 32, 0.85);
      --card-blur: blur(20px);
      --card-border: 1px solid var(--border);
      --card-shadow: 0 10px 30px rgba(0,0,0,0.5);
      --radius: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--fg-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    h1, h2, h3 { font-family: 'Playfair Display', serif; }

    .bg-ambient {
      position: fixed; inset: 0; z-index: 0; overflow: hidden; pointer-events: none;
    }
    .bg-gradient-orb {
      position: absolute; border-radius: 50%; filter: blur(80px);
      animation: float 20s ease-in-out infinite;
    }
    .orb-1 {
      width: 600px; height: 600px;
      background: radial-gradient(circle, var(--accent) 0%, transparent 70%);
      top: -200px; right: -200px; opacity: 0.3;
    }
    .orb-2 {
      width: 500px; height: 500px;
      background: radial-gradient(circle, var(--accent-soft) 0%, transparent 70%);
      bottom: -150px; left: -150px; opacity: 0.25; animation-delay: -10s;
    }
    @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-20px, 20px); } }

    #particles-canvas { position: fixed; inset: 0; z-index: 1; pointer-events: none; }

    .main-wrapper { position: relative; z-index: 10; display: flex; flex-direction: column; min-height: 100vh; }

    .glass-card {
      background: var(--card-bg); backdrop-filter: var(--card-blur);
      -webkit-backdrop-filter: var(--card-blur); border: var(--card-border);
      border-radius: 24px; box-shadow: var(--card-shadow);
    }

    .confession-card {
      background: var(--card-bg); backdrop-filter: var(--card-blur);
      -webkit-backdrop-filter: var(--card-blur); border: var(--card-border);
      border-radius: var(--radius); box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
    }
    .confession-card:active { transform: scale(0.98); }

    #map { height: 100%; width: 100%; z-index: 5; }
    .leaflet-container { background: var(--bg-secondary); }

    .glow-heart-icon {
      display: flex; justify-content: center; align-items: center;
      background: transparent; border: none;
    }
    .glow-heart-icon svg {
      width: 20px; height: 20px; fill: var(--accent);
      filter: drop-shadow(0 0 6px var(--accent)) drop-shadow(0 0 2px white);
      animation: heartbeat 2s infinite ease-in-out; transform-origin: center;
    }
    @keyframes heartbeat {
      0% { transform: scale(1); } 15% { transform: scale(1.15); }
      30% { transform: scale(1); } 45% { transform: scale(1.1); }
      60% { transform: scale(1); } 100% { transform: scale(1); }
    }

    .map-search-container {
      position: absolute; top: 60px; left: 10px; right: 10px;
      z-index: 1000; width: calc(100% - 20px);
    }
    @media (min-width: 768px) {
      .map-search-container { top: 10px; left: 60px; width: 300px; }
    }

    .search-input {
      width: 100%; padding: 12px 16px; background: var(--bg-secondary);
      border: 1px solid var(--border); border-radius: 30px;
      color: var(--fg-primary); font-size: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .search-input:focus { outline: none; border-color: var(--accent); }
    .search-dropdown {
      position: absolute; top: 100%; left: 0; right: 0;
      background: var(--bg-secondary); border: 1px solid var(--border);
      border-radius: 16px; margin-top: 8px; max-height: 250px;
      overflow-y: auto; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .search-item { padding: 12px 18px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
    .search-item:hover { background: rgba(255, 77, 109, 0.1); }

    .input-field {
      background: rgba(0, 0, 0, 0.4); border: 2px solid var(--border);
      border-radius: 12px; padding: 14px 18px; color: var(--fg-primary);
      font-size: 16px; width: 100%; transition: all 0.3s ease;
    }
    .input-field:focus { outline: none; border-color: var(--accent); }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-soft) 100%);
      color: white; border: none; padding: 14px 28px;
      border-radius: 12px; font-weight: 600; cursor: pointer;
      transition: all 0.2s; box-shadow: 0 8px 25px -8px var(--accent);
    }
    .btn-primary:active { transform: scale(0.96); }
    .btn-secondary {
      background: transparent; color: var(--fg-secondary);
      border: 1px solid var(--border); padding: 8px 16px;
      border-radius: 30px; font-weight: 500; cursor: pointer; font-size: 13px;
    }

    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px); z-index: 2000; display: flex;
      align-items: center; justify-content: center;
      opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal-content {
      width: 90%; max-width: 500px; max-height: 90vh;
      border-radius: 24px; transform: scale(0.9);
      transition: transform 0.3s ease; overflow-y: auto; padding: 24px;
      background: var(--bg-secondary); border: 1px solid var(--border);
    }
    .modal-overlay.active .modal-content { transform: scale(1); }

    .theme-panel {
      position: fixed; top: 0; right: 0; width: 320px; height: 100vh;
      background: var(--bg-secondary); border-left: 1px solid var(--border);
      z-index: 1500; transform: translateX(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    }
    .theme-panel.open { transform: translateX(0); }

    .theme-btn {
      display: flex; align-items: center; gap: 12px;
      width: 100%; padding: 12px; border-radius: 12px;
      background: rgba(0,0,0,0.2); border: 1px solid transparent;
      cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
    }
    .theme-btn:hover { border-color: var(--border); }
    .theme-btn.active { border-color: var(--accent); background: rgba(255, 77, 109, 0.1); }
    
    .style-btn {
      flex: 1; padding: 10px; border-radius: 10px;
      background: rgba(0,0,0,0.2); border: 2px solid transparent;
      color: var(--fg-secondary); cursor: pointer; transition: all 0.2s;
      font-size: 12px;
    }
    .style-btn.active { border-color: var(--accent); color: var(--fg-primary); }

    .like-btn { position: relative; }
    .like-btn.liked { color: var(--accent); border-color: var(--accent); background: rgba(255, 77, 109, 0.1); }
    .like-btn.liked svg { fill: var(--accent); }

    .mobile-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bg-secondary); border-top: 1px solid var(--border);
      display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000;
    }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--fg-secondary); background: none; border: none; cursor: pointer; }
    .nav-item.active { color: var(--accent); }
    .nav-item span { font-size: 11px; font-weight: 500; }

    .hidden { display: none !important; }
    .toast {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--accent); color: white; padding: 12px 24px;
      border-radius: 30px; font-weight: 600; z-index: 3000;
      opacity: 0; transition: all 0.3s ease; pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--accent-soft); border-radius: 2px; }
  </style>
</head>
<body>
  <!-- Ambient Background -->
  <div class="bg-ambient">
    <div class="bg-gradient-orb orb-1"></div>
    <div class="bg-gradient-orb orb-2"></div>
  </div>
  <canvas id="particles-canvas"></canvas>

  <!-- Main Wrapper -->
  <div class="main-wrapper pb-20 md:pb-0">
    <!-- Desktop Header -->
    <header class="p-4 md:p-6 hidden md:flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[var(--accent)] to-[var(--accent-soft)] flex items-center justify-center">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
        </div>
        <div>
          <h1 class="text-xl font-semibold">Secret Valentine PH</h1>
          <p class="text-xs text-[var(--fg-secondary)]">Anonymous Confessions</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="openFeedbackModal()" class="btn-secondary text-sm flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Feedback
        </button>
        <button onclick="openHelpModal()" class="btn-secondary text-sm flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
          How to Use
        </button>
        <button onclick="toggleThemePanel()" class="btn-secondary text-sm flex items-center gap-2">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42"/></svg>
          Customize
        </button>
      </div>
    </header>

    <!-- Views Container -->
    <main class="flex-1 overflow-hidden">
      <!-- MAP VIEW -->
      <div id="view-map" class="h-[calc(100vh-80px)] md:h-[calc(100vh-120px)] md:p-4 md:pt-0 relative">
        <div class="absolute top-4 left-4 right-4 z-20 md:hidden flex justify-between items-center">
             <h1 class="text-lg font-semibold" style="font-family: 'Playfair Display', serif;">Secret Valentine</h1>
             <div class="flex gap-2">
                <button onclick="openFeedbackModal()" class="p-2 glass-card rounded-full">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                </button>
                <button onclick="toggleThemePanel()" class="p-2 glass-card rounded-full">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42"/></svg>
                </button>
             </div>
        </div>

        <div class="map-search-container">
          <input type="text" id="map-search-input" class="search-input" placeholder="Search location (e.g., Makati)...">
          <div id="map-search-dropdown" class="search-dropdown"></div>
        </div>

        <div id="map" class="h-full w-full md:rounded-2xl"></div>
        <button onclick="openConfessModal()" class="absolute bottom-24 right-4 md:bottom-8 md:right-8 w-14 h-14 rounded-full bg-gradient-to-br from-[var(--accent)] to-[var(--accent-soft)] shadow-lg flex items-center justify-center z-20 border-2 border-white border-opacity-20 hover:scale-105 transition-transform">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>

      <!-- FEED VIEW -->
      <div id="view-feed" class="hidden p-4 pt-8 overflow-y-auto h-[calc(100vh-80px)] md:h-[calc(100vh-120px)]">
        <div class="max-w-2xl mx-auto">
          <h2 class="text-2xl font-semibold mb-4">Confession Feed</h2>
          <div class="relative mb-4">
             <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 text-[var(--fg-secondary)]" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
             <input type="text" id="feed-search-input" class="input-field pl-10" placeholder="Search location or message..." oninput="renderFeed()">
          </div>
          <div id="confessions-feed" class="space-y-4"></div>
        </div>
      </div>
    </main>

    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-nav md:hidden">
      <button class="nav-item active" data-view="map" onclick="switchView('map')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
        <span>Map</span>
      </button>
      <button class="nav-item" data-view="feed" onclick="switchView('feed')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <span>Feed</span>
      </button>
      <button class="nav-item" onclick="openHelpModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        <span>Help</span>
      </button>
      <button class="nav-item" onclick="toggleThemePanel()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42"/></svg>
        <span>Theme</span>
      </button>
    </nav>
  </div>

  <!-- THEME SIDEBAR -->
  <div id="theme-panel" class="theme-panel">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Customize</h3>
        <button onclick="toggleThemePanel()" class="p-2 opacity-60 hover:opacity-100">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <div class="mb-6">
        <h4 class="text-xs font-semibold text-[var(--fg-secondary)] uppercase tracking-wider mb-3">Preset Themes</h4>
        <button onclick="applyTheme('romantic')" class="theme-btn active" data-theme="romantic">
          <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #ff4d6d, #ff758f);"></div>
          <span class="font-medium">Romantic Red</span>
        </button>
        <button onclick="applyTheme('ocean')" class="theme-btn" data-theme="ocean">
          <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #00d9ff, #4de8ff);"></div>
          <span class="font-medium">Ocean Blue</span>
        </button>
        <button onclick="applyTheme('forest')" class="theme-btn" data-theme="forest">
          <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #22c55e, #4ade80);"></div>
          <span class="font-medium">Forest Green</span>
        </button>
        <button onclick="applyTheme('sunset')" class="theme-btn" data-theme="sunset">
          <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #f8b500, #ffc94d);"></div>
          <span class="font-medium">Sunset Orange</span>
        </button>
        <button onclick="applyTheme('lavender')" class="theme-btn" data-theme="lavender">
          <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #a855f7, #c084fc);"></div>
          <span class="font-medium">Lavender</span>
        </button>
        <button onclick="applyTheme('midnight')" class="theme-btn" data-theme="midnight">
          <div class="w-8 h-8 rounded-full" style="background: linear-gradient(135deg, #6366f1, #818cf8);"></div>
          <span class="font-medium">Midnight</span>
        </button>
      </div>

      <div class="mb-6">
        <h4 class="text-xs font-semibold text-[var(--fg-secondary)] uppercase tracking-wider mb-3">Custom Accent</h4>
        <div class="flex items-center gap-4 bg-black/20 p-3 rounded-xl border border-white/5">
            <input type="color" id="color-picker" value="#ff4d6d" onchange="updateCustomColor(this.value)" class="w-10 h-10 rounded-lg cursor-pointer border-none bg-transparent">
            <div>
                <p class="text-sm font-medium">Pick a Color</p>
                <p class="text-xs text-[var(--fg-secondary)]" id="color-hex">#FF4D6D</p>
            </div>
        </div>
      </div>

      <div class="mb-6">
        <h4 class="text-xs font-semibold text-[var(--fg-secondary)] uppercase tracking-wider mb-3">Card Style</h4>
        <div class="flex gap-2">
          <button onclick="setCardStyle('glass')" class="style-btn active" id="style-glass">Glass</button>
          <button onclick="setCardStyle('solid')" class="style-btn" id="style-solid">Solid</button>
          <button onclick="setCardStyle('minimal')" class="style-btn" id="style-minimal">Minimal</button>
        </div>
      </div>

      <button onclick="resetTheme()" class="btn-secondary w-full mt-4">Reset to Default</button>
    </div>
  </div>

  <!-- HOW TO USE MODAL -->
  <div id="help-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">How to Use</h3>
        <button onclick="closeHelpModal()" class="p-2 opacity-60"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="space-y-4">
        <div class="flex gap-4">
          <div class="w-10 h-10 rounded-full bg-[var(--accent)] flex items-center justify-center flex-shrink-0 font-bold">1</div>
          <div>
            <h4 class="font-semibold mb-1">Write a Confession</h4>
            <p class="text-sm text-[var(--fg-secondary)]">Click the Pink (+) button to start. Write your message and pick a color.</p>
          </div>
        </div>
        <div class="flex gap-4">
          <div class="w-10 h-10 rounded-full bg-[var(--accent)] flex items-center justify-center flex-shrink-0 font-bold">2</div>
          <div>
            <h4 class="font-semibold mb-1">Set a Location Hint</h4>
            <p class="text-sm text-[var(--fg-secondary)]">Type the location (Barangay/Street). This helps your crush to have hints about you!</p>
          </div>
        </div>
        <div class="flex gap-4">
          <div class="w-10 h-10 rounded-full bg-[var(--accent)] flex items-center justify-center flex-shrink-0 font-bold">3</div>
          <div>
            <h4 class="font-semibold mb-1">Explore the Map</h4>
            <p class="text-sm text-[var(--fg-secondary)]">Use the search bar on the map to jump to places. Tap glowing hearts to read confessions.</p>
          </div>
        </div>
      </div>
      <button onclick="closeHelpModal()" class="btn-primary w-full mt-8">Got it!</button>
    </div>
  </div>

  <!-- FEEDBACK MODAL -->
  <div id="feedback-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Send Feedback</h3>
        <button onclick="closeFeedbackModal()" class="p-2 opacity-60"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <form onsubmit="submitFeedback(event)">
        <div class="mb-4">
          <label class="text-sm font-medium text-[var(--fg-secondary)] mb-2 block">Your Feedback</label>
          <textarea id="feedback-text" class="input-field" placeholder="Suggestions, bugs, or love notes..." required style="min-height: 100px;"></textarea>
        </div>
        <button type="submit" class="btn-primary w-full">Submit</button>
      </form>
    </div>
  </div>

  <!-- CONFESS MODAL -->
  <div id="confess-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold">Send a Confession</h3>
        <button onclick="closeConfessModal()" class="p-2 opacity-60"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <form id="confession-form" onsubmit="submitConfession(event)">
        <div class="space-y-4">
          <div>
            <label class="text-sm font-medium text-[var(--fg-secondary)] mb-2 block">Your Message</label>
            <textarea id="confession-text" class="input-field" placeholder="Type your anonymous confession here..." required style="min-height: 100px;"></textarea>
          </div>
          <div class="relative">
            <label class="text-sm font-medium text-[var(--fg-secondary)] mb-2 block">Location Hint (Philippines)</label>
            <input type="text" id="location-search" class="input-field" placeholder="e.g., Barangay 76, Sampaguita St..." autocomplete="off" required>
            <input type="hidden" id="selected-lat"><input type="hidden" id="selected-lng"><input type="hidden" id="selected-address">
            <div id="location-dropdown" class="search-dropdown" style="position: absolute; width: 100%;"></div>
            <p class="text-xs opacity-50 mt-1">Be specific so your crush knows it's them!</p>
          </div>
          <div>
            <label class="text-sm font-medium text-[var(--fg-secondary)] mb-2 block">Card Color</label>
            <div class="flex gap-2">
              <button type="button" onclick="selectCardColor('#ff4d6d')" class="w-10 h-10 rounded-full border-2 border-white card-color-btn" style="background: #ff4d6d;" data-color="#ff4d6d"></button>
              <button type="button" onclick="selectCardColor('#ff6b9d')" class="w-10 h-10 rounded-full border-2 border-transparent card-color-btn" style="background: #ff6b9d;" data-color="#ff6b9d"></button>
              <button type="button" onclick="selectCardColor('#00d9ff')" class="w-10 h-10 rounded-full border-2 border-transparent card-color-btn" style="background: #00d9ff;" data-color="#00d9ff"></button>
              <button type="button" onclick="selectCardColor('#f8b500')" class="w-10 h-10 rounded-full border-2 border-transparent card-color-btn" style="background: #f8b500;" data-color="#f8b500"></button>
            </div>
          </div>
          <button type="submit" class="btn-primary w-full mt-4">Send Anonymously</button>
        </div>
      </form>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div id="detail-modal" class="modal-overlay">
    <div class="modal-content" id="detail-content"></div>
  </div>
  
  <div id="toast" class="toast">Message Sent!</div>

  <script>
    // Django CSRF Token handling
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // API Base URL
    const API_URL = '/api';

    // State
    const PH_CENTER = [12.8797, 121.7740];
    const PH_BOUNDS = [[4.5, 116.9], [21.1, 126.6]];
    let map = null;
    let markers = {};
    let confessions = [];
    let likedIds = new Set(JSON.parse(localStorage.getItem('likedConfessions') || '[]'));
    let selectedCardColor = '#ff4d6d';
    
    const themes = {
      romantic: { bg: '#1a0a14', bgSec: '#2d1520', acc: '#ff4d6d', accSoft: '#ff758f' },
      ocean: { bg: '#0a1628', bgSec: '#152238', acc: '#00d9ff', accSoft: '#4de8ff' },
      forest: { bg: '#0a1a14', bgSec: '#152d20', acc: '#22c55e', accSoft: '#4ade80' },
      sunset: { bg: '#1a140a', bgSec: '#2d2015', acc: '#f8b500', accSoft: '#ffc94d' },
      lavender: { bg: '#1a0a1a', bgSec: '#2d152d', acc: '#a855f7', accSoft: '#c084fc' },
      midnight: { bg: '#0a0a14', bgSec: '#151520', acc: '#6366f1', accSoft: '#818cf8' }
    };

    // Initialization
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      initParticles();
      initMapSearch();
      loadData();
    });

    async function loadData() {
      try {
        const response = await fetch(`${API_URL}/confessions/`);
        const data = await response.json();
        confessions = data.map(c => ({
          id: c.id,
          text: c.text,
          location: {
            lat: c.latitude,
            lng: c.longitude,
            name: c.location_name
          },
          color: c.color,
          likes: c.likes,
          timestamp: new Date(c.created_at).getTime()
        }));
        updateMapMarkers();
        renderFeed();
      } catch (error) {
        console.error('Error loading confessions:', error);
        showToast('Error loading data');
      }
    }

    async function saveData(newConfession) {
      try {
        const response = await fetch(`${API_URL}/confessions/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            text: newConfession.text,
            latitude: newConfession.location.lat,
            longitude: newConfession.location.lng,
            location_name: newConfession.location.name,
            color: newConfession.color
          })
        });
        if (response.ok) {
          await loadData();
        } else {
          throw new Error('Failed to save');
        }
      } catch (error) {
        console.error('Error saving confession:', error);
        showToast('Error posting confession');
      }
    }

    // Map Logic
    function initMap() {
      map = L.map('map', { 
        center: PH_CENTER, 
        zoom: 6, 
        maxBounds: PH_BOUNDS, 
        maxBoundsViscosity: 1.0, 
        zoomControl: false 
      });
      L.control.zoom({ position: 'topright' }).addTo(map);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
        attribution: '&copy; OSM &copy; CARTO', 
        subdomains: 'abcd', 
        maxZoom: 19 
      }).addTo(map);
    }
    
    function initMapSearch() {
      const input = document.getElementById('map-search-input');
      const dropdown = document.getElementById('map-search-dropdown');
      let timeout = null;

      input.addEventListener('input', (e) => {
        const query = e.target.value;
        clearTimeout(timeout);
        if (query.length < 3) { dropdown.style.display = 'none'; return; }

        timeout = setTimeout(() => {
          fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=ph`)
            .then(res => res.json()).then(data => {
              dropdown.innerHTML = '';
              if (data.length > 0) {
                dropdown.style.display = 'block';
                data.forEach(place => {
                  const item = document.createElement('div'); item.className = 'search-item';
                  item.textContent = place.display_name;
                  item.onclick = () => {
                    input.value = place.display_name.split(',')[0];
                    map.flyTo([place.lat, place.lon], 15);
                    dropdown.style.display = 'none';
                  };
                  dropdown.appendChild(item);
                });
              } else { dropdown.style.display = 'none'; }
            });
        }, 500);
      });
      
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.map-search-container')) dropdown.style.display = 'none';
      });
    }

    function updateMapMarkers() {
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};

      confessions.forEach(c => {
        if (c.location && c.location.lat && c.location.lng) {
          const icon = L.divIcon({
            className: 'glow-heart-icon',
            html: `<svg viewBox="0 0 24 24" style="fill: ${c.color || 'var(--accent)'}; stroke: white; stroke-width: 1;">
                     <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                   </svg>`,
            iconSize: [20, 20],
            iconAnchor: [10, 18]
          });

          const marker = L.marker([c.location.lat, c.location.lng], { icon: icon })
            .addTo(map)
            .on('click', () => {
              map.flyTo([c.location.lat, c.location.lng], 16, { duration: 0.5 });
              showDetail(c.id);
            });
          
          markers[c.id] = marker;
        }
      });
    }

    // UI Logic
    function switchView(viewName) {
      document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(`view-${viewName}`).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.toggle('active', btn.dataset.view === viewName));
      if (viewName === 'map' && map) setTimeout(() => map.invalidateSize(), 100);
    }
    function toggleThemePanel() { document.getElementById('theme-panel').classList.toggle('open'); }
    
    function openHelpModal() { document.getElementById('help-modal').classList.add('active'); }
    function closeHelpModal() { document.getElementById('help-modal').classList.remove('active'); }

    function openFeedbackModal() { document.getElementById('feedback-modal').classList.add('active'); }
    function closeFeedbackModal() { document.getElementById('feedback-modal').classList.remove('active'); }

    function showToast(msg) {
      const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Theme & Customization
    function applyTheme(themeName) {
      const t = themes[themeName];
      if (!t) return;
      document.documentElement.style.setProperty('--bg-primary', t.bg);
      document.documentElement.style.setProperty('--bg-secondary', t.bgSec);
      document.documentElement.style.setProperty('--accent', t.acc);
      document.documentElement.style.setProperty('--accent-soft', t.accSoft);
      document.documentElement.style.setProperty('--border', `${t.acc}33`);
      document.body.style.background = t.bg;
      document.querySelector('.orb-1').style.background = `radial-gradient(circle, ${t.acc} 0%, transparent 70%)`;
      document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.theme-btn[data-theme="${themeName}"]`)?.classList.add('active');
      document.getElementById('color-picker').value = t.acc;
      document.getElementById('color-hex').textContent = t.acc.toUpperCase();
      updateMapMarkers();
    }

    function updateCustomColor(color) {
      document.documentElement.style.setProperty('--accent', color);
      document.documentElement.style.setProperty('--border', `${color}33`);
      document.querySelector('.orb-1').style.background = `radial-gradient(circle, ${color} 0%, transparent 70%)`;
      document.getElementById('color-hex').textContent = color.toUpperCase();
      updateMapMarkers();
    }

    function setCardStyle(style) {
      const root = document.documentElement.style;
      document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`style-${style}`).classList.add('active');
      if (style === 'glass') {
        root.setProperty('--card-bg', 'rgba(45, 21, 32, 0.85)'); root.setProperty('--card-blur', 'blur(20px)');
        root.setProperty('--card-border', '1px solid var(--border)'); root.setProperty('--card-shadow', '0 10px 30px rgba(0,0,0,0.5)');
      } else if (style === 'solid') {
        root.setProperty('--card-bg', 'var(--bg-secondary)'); root.setProperty('--card-blur', 'blur(0px)');
        root.setProperty('--card-border', 'none'); root.setProperty('--card-shadow', '0 5px 15px rgba(0,0,0,0.2)');
      } else if (style === 'minimal') {
        root.setProperty('--card-bg', 'transparent'); root.setProperty('--card-blur', 'blur(0px)');
        root.setProperty('--card-border', '1px solid rgba(255,255,255,0.1)'); root.setProperty('--card-shadow', 'none');
      }
    }

    function resetTheme() { applyTheme('romantic'); setCardStyle('glass'); }

    // Data Logic
    const locationInput = document.getElementById('location-search');
    const dropdown = document.getElementById('location-dropdown');

    locationInput.addEventListener('input', (e) => {
      const query = e.target.value;
      clearTimeout(window.searchTimeout);
      if (query.length < 3) { dropdown.style.display = 'none'; return; }
      
      window.searchTimeout = setTimeout(() => {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}&limit=5&countrycodes=ph`)
          .then(res => res.json()).then(data => {
            dropdown.innerHTML = '';
            if (data.length > 0) {
              dropdown.style.display = 'block';
              data.forEach(place => {
                const item = document.createElement('div'); item.className = 'search-item';
                const addr = place.address;
                let name = place.display_name;
                const parts = [];
                if (addr.shop || addr.amenity) parts.push(addr.shop || addr.amenity);
                if (addr.road) parts.push(addr.road);
                if (addr.suburb || addr.neighbourhood) parts.push(addr.suburb || addr.neighbourhood);
                if (parts.length) name = parts.join(', ') + (addr.city ? `, ${addr.city}` : '');
                
                item.textContent = name;
                item.onclick = () => {
                  locationInput.value = name;
                  document.getElementById('selected-lat').value = place.lat;
                  document.getElementById('selected-lng').value = place.lon;
                  document.getElementById('selected-address').value = name;
                  dropdown.style.display = 'none';
                };
                dropdown.appendChild(item);
              });
            } else { dropdown.style.display = 'none'; }
          });
      }, 500);
    });
    
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#location-search')) dropdown.style.display = 'none';
    });

    function openConfessModal() { 
      document.getElementById('confess-modal').classList.add('active'); 
      document.getElementById('confession-form').reset(); 
      selectCardColor('#ff4d6d'); 
    }
    function closeConfessModal() { document.getElementById('confess-modal').classList.remove('active'); }

    async function submitConfession(e) {
      e.preventDefault();
      const text = document.getElementById('confession-text').value.trim();
      const lat = parseFloat(document.getElementById('selected-lat').value);
      const lng = parseFloat(document.getElementById('selected-lng').value);
      const locName = document.getElementById('selected-address').value;

      if (!text || !lat || !lng) { showToast("Please select a valid location."); return; }

      const newConf = { 
        text, 
        location: { lat, lng, name: locName }, 
        timestamp: Date.now(), 
        color: selectedCardColor, 
        likes: 0 
      };

      await saveData(newConf);
      closeConfessModal(); 
      showToast("Confession Posted!");
      map.flyTo([lat, lng], 15);
    }

    async function submitFeedback(e) {
      e.preventDefault();
      const text = document.getElementById('feedback-text').value;
      try {
        await fetch(`${API_URL}/feedback/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ text })
        });
        closeFeedbackModal();
        showToast("Thanks for your feedback!");
      } catch (error) {
        console.error('Error submitting feedback:', error);
        showToast("Error sending feedback");
      }
    }

    function selectCardColor(color) {
      selectedCardColor = color;
      document.querySelectorAll('.card-color-btn').forEach(btn => 
        btn.style.borderColor = btn.dataset.color === color ? 'white' : 'transparent'
      );
    }

    // Feed & Detail
    function renderFeed() {
      const container = document.getElementById('confessions-feed');
      const searchQuery = document.getElementById('feed-search-input').value.toLowerCase();

      const filtered = confessions.filter(c => {
        if(!searchQuery) return true;
        const inText = c.text.toLowerCase().includes(searchQuery);
        const inLoc = c.location.name.toLowerCase().includes(searchQuery);
        return inText || inLoc;
      });
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <div class="w-16 h-16 rounded-full bg-[var(--accent)] bg-opacity-20 flex items-center justify-center mx-auto mb-4">
               <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </div>
            <h3 class="text-xl font-semibold mb-2">${searchQuery ? 'No results found' : 'No confessions yet'}</h3>
            <p class="text-[var(--fg-secondary)] text-sm mb-6">${searchQuery ? 'Try a different search term.' : 'Be the first to share your heart out!'}</p>
            ${!searchQuery ? `<button onclick="openConfessModal()" class="btn-primary">Write a Confession</button>` : ''}
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(c => {
        const isLiked = likedIds.has(c.id);
        return `
        <div class="confession-card p-4 cursor-pointer" onclick="showDetail('${c.id}')">
          <div class="flex justify-between items-start mb-2">
            <div class="location-badge" style="font-size:11px; display:inline-flex; align-items:center; gap:6px; background:rgba(0,0,0,0.2); padding:4px 10px; border-radius:20px;">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
              ${c.location.name}
            </div>
            <span class="text-xs opacity-50">${formatTime(c.timestamp)}</span>
          </div>
          <p class="text-sm leading-relaxed mb-3">${c.text}</p>
          <div class="flex items-center gap-2 text-xs text-[var(--fg-secondary)]">
            <button onclick="event.stopPropagation(); toggleLike('${c.id}')" class="like-btn ${isLiked ? 'liked' : ''}" style="padding:4px; border-radius:50%; border:1px solid transparent;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </button>
            <span>${c.likes}</span>
          </div>
        </div>`;
      }).join('');
    }

    function showDetail(id) {
      const c = confessions.find(x => x.id === id); if(!c) return;
      const isLiked = likedIds.has(id);
      document.getElementById('detail-content').innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <div class="location-badge" style="font-size: 12px; padding: 6px 12px; background:rgba(0,0,0,0.3); border-radius:20px;">
             <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline; vertical-align:middle; margin-right:4px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
             ${c.location.name}
          </div>
          <button onclick="closeDetailModal()" class="p-1 opacity-60"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <p class="text-lg leading-relaxed mb-6">${c.text}</p>
        <div class="flex justify-between items-center">
            <span class="text-xs opacity-50">${formatTime(c.timestamp)}</span>
            <button onclick="toggleLike('${c.id}')" class="like-btn btn-secondary ${isLiked ? 'liked' : ''}" style="padding: 8px 20px; display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                ${isLiked ? 'Liked' : 'Like'}
            </button>
        </div>`;
      document.getElementById('detail-modal').classList.add('active');
    }

    async function toggleLike(id) {
      const c = confessions.find(x => x.id === id); 
      if(!c) return;
      
      const wasLiked = likedIds.has(id);
      
      try {
        const response = await fetch(`${API_URL}/confessions/${id}/like/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          c.likes = data.likes;
          
          if (wasLiked) {
            likedIds.delete(id);
          } else {
            likedIds.add(id);
          }
          
          localStorage.setItem('likedConfessions', JSON.stringify(Array.from(likedIds)));
          renderFeed();
          if (document.getElementById('detail-modal').classList.contains('active')) {
            showDetail(id);
          }
        }
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }

    function closeDetailModal() { document.getElementById('detail-modal').classList.remove('active'); }

    function formatTime(timestamp) {
      const diff = Date.now() - timestamp;
      if (diff < 3600000) return `${Math.floor(diff/60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff/3600000)}h ago`;
      return `${Math.floor(diff/86400000)}d ago`;
    }

    // Particles
    function initParticles() {
      const canvas = document.getElementById('particles-canvas');
      const ctx = canvas.getContext('2d');
      let particles = [];
      const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
      window.addEventListener('resize', resize); resize();

      function create() { 
        return { 
          x: Math.random() * canvas.width, 
          y: canvas.height + 20, 
          size: Math.random() * 10 + 5, 
          speed: Math.random() * 1 + 0.5, 
          opacity: Math.random() * 0.4 + 0.1 
        }; 
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (particles.length < 25) particles.push(create());
        particles.forEach((p, i) => {
          p.y -= p.speed;
          ctx.save(); 
          ctx.translate(p.x, p.y); 
          ctx.scale(p.size/10, p.size/10);
          ctx.beginPath(); 
          ctx.moveTo(0, -3); 
          ctx.bezierCurveTo(-5, -10, -10, 0, 0, 8); 
          ctx.bezierCurveTo(10, 0, 5, -10, 0, -3);
          ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff4d6d';
          ctx.globalAlpha = p.opacity; 
          ctx.fill(); 
          ctx.restore();
          if (p.y < -20) particles.splice(i, 1);
        });
        requestAnimationFrame(animate);
      }
      animate();
    }
  </script>
</body>
</html>